<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cloud Budget Tracker</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Cloud Budget">

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); min-height: 100vh; color: #1e293b; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.5); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border-radius: 16px; }
        input, select, button { font-size: 16px !important; }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        .uncategorized-row { border-left: 4px solid #fbbf24 !important; background-color: #fffbeb !important; }
        .uncategorized-tag { background-color: #fcd34d !important; color: #78350f !important; font-weight: 700; }
    </style>
</head>
<body class="pb-24">

    <!-- AUTH SCREEN -->
    <div id="auth-container" class="min-h-screen flex items-center justify-center p-4">
        <div class="glass-panel p-8 w-full max-w-md space-y-6">
            <h1 class="text-3xl font-bold text-center text-slate-800">Budget Sync</h1>
            <div id="config-form" class="hidden space-y-3">
                <div class="bg-amber-50 border border-amber-200 p-3 rounded-lg text-xs text-amber-800"><strong>Setup:</strong> Paste Firebase Config object.</div>
                <textarea id="firebase-config-input" rows="5" class="w-full p-3 border rounded-xl text-xs font-mono bg-slate-50"></textarea>
                <button onclick="saveConfig()" class="w-full py-3 bg-slate-800 text-white rounded-xl font-bold shadow">Connect</button>
            </div>
            <div id="login-form" class="hidden space-y-4">
                <input type="email" id="email" placeholder="Email" class="w-full p-3 border rounded-xl bg-gray-50" />
                <input type="password" id="password" placeholder="Password" class="w-full p-3 border rounded-xl bg-gray-50" />
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="handleLogin()" class="py-3 bg-indigo-600 text-white rounded-xl font-bold shadow">Log In</button>
                    <button onclick="handleRegister()" class="py-3 bg-white text-indigo-600 border border-indigo-100 rounded-xl font-bold">Sign Up</button>
                </div>
                <p id="auth-error" class="text-rose-500 text-center text-sm hidden"></p>
            </div>
            <div id="loading-state" class="hidden text-center text-slate-400 text-sm animate-pulse">Connecting...</div>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard-container" class="hidden max-w-7xl mx-auto p-4 md:p-6 space-y-6">
        <header class="flex flex-col md:flex-row justify-between items-center gap-4 glass-panel p-4 sticky top-2 z-50">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-100 p-2 rounded-lg text-indigo-600"><i data-lucide="layout-dashboard" class="w-5 h-5"></i></div>
                <div><h1 class="text-lg font-bold leading-tight">My Budget</h1><p id="user-email-display" class="text-[10px] text-slate-400 font-mono"></p></div>
            </div>
            <div class="flex items-center gap-2 w-full md:w-auto">
                <select id="month-selector" onchange="window.updateDashboard()" class="w-full md:w-40 p-2 bg-slate-100 border-none rounded-lg text-sm font-semibold text-slate-700"><option value="all">All Time</option></select>
                <button onclick="handleLogout()" class="p-2 text-slate-400 hover:bg-slate-100 rounded-lg"><i data-lucide="log-out" class="w-5 h-5"></i></button>
            </div>
        </header>

        <!-- Summary & Charts -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="summary-cards"></div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="glass-panel p-5"><h3 class="text-sm font-bold text-slate-700 mb-4">Budget vs. Actual</h3><div class="h-64"><canvas id="budgetChart"></canvas></div></div>
            <div class="glass-panel p-5"><h3 class="text-sm font-bold text-slate-700 mb-4">Spending Breakdown</h3><div class="h-64 flex justify-center"><canvas id="spendingChart"></canvas></div></div>
        </div>

        <!-- Main Content -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Data -->
            <div class="lg:col-span-2 space-y-6 order-1 lg:order-2">
                <div class="glass-panel overflow-hidden">
                    <div class="px-5 py-3 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center"><h3 class="text-sm font-bold text-slate-700">Budget Performance</h3><span id="budget-multiplier-label" class="text-[10px] bg-indigo-100 text-indigo-700 px-2 py-1 rounded-full font-mono">Monthly</span></div>
                    <div class="overflow-x-auto max-h-96 custom-scroll"><table class="w-full text-sm text-left"><thead class="text-xs text-slate-400 uppercase bg-slate-50 sticky top-0"><tr><th class="px-5 py-3">Category</th><th class="px-5 py-3 text-right">Limit</th><th class="px-5 py-3 text-right">Spent</th><th class="px-5 py-3 text-right">Left</th></tr></thead><tbody id="budget-table-body"></tbody></table></div>
                </div>
                <div class="glass-panel overflow-hidden">
                    <div class="px-5 py-3 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center gap-2">
                        <div class="flex items-center gap-2"><h3 class="text-sm font-bold text-slate-700">History</h3><button id="clear-all-btn" onclick="window.clearAllTransactions()" class="hidden text-[10px] bg-rose-50 text-rose-600 px-2 py-1 rounded font-bold hover:bg-rose-100">Clear All</button></div>
                        <input type="text" id="search-input" placeholder="Search..." class="pl-2 pr-2 py-1 text-xs border border-slate-200 rounded-lg w-32" oninput="window.updateDashboard()">
                    </div>
                    <div class="overflow-x-auto max-h-[500px] custom-scroll"><table class="w-full text-sm text-left"><thead class="text-xs text-slate-400 uppercase bg-slate-50 sticky top-0"><tr><th class="px-5 py-3">Date</th><th class="px-5 py-3">Desc</th><th class="px-5 py-3">Category</th><th class="px-5 py-3 text-right">Amt</th><th class="px-5 py-3 w-8"></th></tr></thead><tbody id="history-table-body"></tbody></table></div>
                </div>
                <div class="glass-panel p-5"><h3 class="text-sm font-bold text-slate-700 mb-4 border-b pb-2">Area Totals</h3><div id="group-breakdown-list" class="space-y-3"></div></div>
            </div>
            <!-- Controls -->
            <div class="lg:col-span-1 space-y-4 order-2 lg:order-1">
                <div class="glass-panel p-5">
                    <h3 class="text-sm font-bold text-slate-700 mb-4 flex items-center gap-2"><i data-lucide="upload-cloud" class="w-4 h-4"></i> Import</h3>
                    <div class="space-y-4">
                        <div class="p-4 border-2 border-dashed border-indigo-100 rounded-xl bg-indigo-50/30 hover:bg-indigo-50 transition relative text-center">
                            <input type="file" id="csv-input" accept=".csv" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"/>
                            <i data-lucide="file-spreadsheet" class="w-8 h-8 text-indigo-400 mx-auto mb-2"></i>
                            <p class="text-xs font-bold text-indigo-600">Upload Transactions</p>
                            <p class="text-[10px] text-slate-400">Bank CSV or Simple Format</p>
                        </div>
                        <div class="p-3 border border-slate-100 rounded-xl flex justify-between items-center bg-slate-50/50">
                            <div class="text-xs"><p class="font-bold text-slate-700">Rules CSV</p></div>
                            <label class="cursor-pointer bg-white border border-slate-200 text-slate-600 px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm">Upload<input type="file" id="rules-input" accept=".csv" class="hidden"/></label>
                        </div>
                    </div>
                </div>
                <div class="glass-panel p-5" id="category-manager-container"></div>
                <div class="p-4 rounded-xl border border-slate-200 bg-slate-100/50 grid grid-cols-2 gap-2">
                    <button onclick="window.downloadBackup()" class="bg-white border border-slate-200 text-slate-600 py-2 rounded-lg text-xs font-bold">Backup JSON</button>
                    <button onclick="window.exportPortableReport()" class="bg-white border border-slate-200 text-slate-600 py-2 rounded-lg text-xs font-bold">HTML Report</button>
                    <label class="cursor-pointer bg-white border border-slate-200 text-slate-600 py-2 rounded-lg text-xs font-bold text-center col-span-2">Restore JSON<input type="file" class="hidden" accept=".json" onchange="window.restoreBackup(event)"></label>
                </div>
            </div>
        </div>
        <div id="feedback-container" class="fixed top-4 right-4 z-50 pointer-events-none"></div>
    </div>

    <script>
        lucide.createIcons();
        // --- CONFIG ---
        const firebaseConfig = {
  apiKey: "AIzaSyCvMCXuKODkxL2Ni9axSNb4LN7GgtDfazM",
  authDomain: "tb-budget-app.firebaseapp.com",
  projectId: "tb-budget-app",
  storageBucket: "tb-budget-app.firebasestorage.app",
  messagingSenderId: "339537167812",
  appId: "1:339537167812:web:a5012ceb3ae64ae120d091",
  measurementId: "G-LDL269R8YQ"
};

        // --- STATE ---
        let app, auth, db, user;
        let categories=[], transactions=[], rules=[], charts={}, editingId=null, currentMonthFilter='all';

        // --- DEFAULTS ---
        const DEFAULT_CATEGORIES = [
            { id: 'unc-inc', name: 'Uncategorized Income', type: 'income', group: 'Income', budget: 0, sort: 1 },
            { id: 'unc-exp', name: 'Uncategorized Expense', type: 'expense', group: 'Other Expenses', budget: 0, sort: 99 },
            { id: 'nec-1', name: 'Groceries & Household', type: 'expense', group: 'Necessary Spending', budget: 850.00, sort: 10 },
            { id: 'nec-2', name: 'House (auto-pay)', type: 'expense', group: 'Necessary Spending', budget: 2150.64, sort: 11 },
            { id: 'nec-3', name: 'EDJ Roth auto-draft (1st of month)', type: 'expense', group: 'Necessary Spending', budget: 460.00, sort: 12 },
            { id: 'nec-4', name: 'Electric (Ameren)', type: 'expense', group: 'Necessary Spending', budget: 200.00, sort: 13 },
            { id: 'nec-5', name: 'Waste Management', type: 'expense', group: 'Necessary Spending', budget: 35.00, sort: 14 },
            { id: 'nec-6', name: 'Water (PWSD)', type: 'expense', group: 'Necessary Spending', budget: 100.00, sort: 15 },
            { id: 'nec-7', name: 'Sewage (American Water)', type: 'expense', group: 'Necessary Spending', budget: 70.00, sort: 16 },
            { id: 'nec-8', name: 'Gas', type: 'expense', group: 'Necessary Spending', budget: 400.00, sort: 17 },
            { id: 'nec-9', name: 'Internet (Spectrum)', type: 'expense', group: 'Necessary Spending', budget: 50.00, sort: 18 },
            { id: 'nec-10', name: 'Gym Membership', type: 'expense', group: 'Necessary Spending', budget: 60.00, sort: 19 },
            { id: 'nec-11', name: 'T-Mobile Cell Phone (auto-pay)', type: 'expense', group: 'Necessary Spending', budget: 60.00, sort: 20 },
            { id: 'nec-12', name: 'Medical Insurance', type: 'expense', group: 'Necessary Spending', budget: 52.00, sort: 21 },
            { id: 'nec-13', name: 'Lincoln Life Ins. ($26 & $22)', type: 'expense', group: 'Necessary Spending', budget: 48.00, sort: 22 },
            { id: 'nec-14', name: 'Dental Insurance (Trevor)', type: 'expense', group: 'Necessary Spending', budget: 24.00, sort: 23 },
            { id: 'nec-15', name: 'USAA (Car Insurance $90 twice/mo)', type: 'expense', group: 'Necessary Spending', budget: 208.00, sort: 24 },
            { id: 'nec-16', name: 'Zander (ID Theft)', type: 'expense', group: 'Necessary Spending', budget: 13.00, sort: 25 },
            { id: 'nec-17', name: 'App (25th auto-pay)', type: 'expense', group: 'Necessary Spending', budget: 17.00, sort: 26 },
            { id: 'giv-1', name: 'Church', type: 'expense', group: 'Giving', budget: 325.00, sort: 30 },
            { id: 'giv-2', name: 'Multiply Campaign', type: 'expense', group: 'Giving', budget: 85.00, sort: 31 },
            { id: 'giv-3', name: 'Bloom INTL', type: 'expense', group: 'Giving', budget: 40.00, sort: 32 },
            { id: 'giv-4', name: 'Convoy of Hope', type: 'expense', group: 'Giving', budget: 51.50, sort: 33 },
            { id: 'giv-5', name: 'DirectConnect (PayPal 25th)', type: 'expense', group: 'Giving', budget: 20.00, sort: 34 },
            { id: 'giv-6', name: 'Cheryl Recurring Donation', type: 'expense', group: 'Giving', budget: 51.50, sort: 35 },
            { id: 'giv-7', name: 'Joy FM', type: 'expense', group: 'Giving', budget: 40.00, sort: 36 },
            { id: 'giv-8', name: 'Hostetter Ministries', type: 'expense', group: 'Giving', budget: 80.00, sort: 37 },
            { id: 'giv-9', name: 'Micellaneous Giving', type: 'expense', group: 'Giving', budget: 0.00, sort: 38 },
            { id: 'giv-10', name: 'Transfer to Giving Savings', type: 'expense', group: 'Giving', budget: 40.00, sort: 39 },
            { id: 'add-1', name: 'Eating Out/Dates', type: 'expense', group: 'Additional Spending', budget: 100.00, sort: 50 },
            { id: 'add-2', name: 'Kristi Fun Money', type: 'expense', group: 'Additional Spending', budget: 0.00, sort: 51 },
            { id: 'add-3', name: 'Trevor Fun Money', type: 'expense', group: 'Additional Spending', budget: 50.00, sort: 52 },
            { id: 'add-4', name: 'icloud', type: 'expense', group: 'Additional Spending', budget: 4.00, sort: 53 },
            { id: 'add-5', name: 'Streaming', type: 'expense', group: 'Additional Spending', budget: 10.00, sort: 54 },
            { id: 'add-6', name: 'Home Spending', type: 'expense', group: 'Additional Spending', budget: 0.00, sort: 55 },
            { id: 'add-7', name: 'Extra House Savings', type: 'expense', group: 'Additional Spending', budget: 150.00, sort: 56 },
            { id: 'add-8', name: 'Overflow Savings', type: 'expense', group: 'Additional Spending', budget: 400.00, sort: 57 },
            { id: 'add-9', name: 'Edward Jones Joint Transfer', type: 'expense', group: 'Additional Spending', budget: 0.00, sort: 58 },
            { id: 'add-10', name: 'Arkansas Trip', type: 'expense', group: 'Additional Spending', budget: 0.00, sort: 59 },
            { id: 'add-11', name: 'Doggy Daycare', type: 'expense', group: 'Additional Spending', budget: 144.00, sort: 60 },
            { id: 'add-12', name: 'Unbudgeted Expenses', type: 'expense', group: 'Additional Spending', budget: 0.00, sort: 61 },
            { id: 'inc-1', name: 'Salary (Kristi)', type: 'income', group: 'Income', budget: 0, sort: 2 },
            { id: 'inc-2', name: 'Salary (Trevor)', type: 'income', group: 'Income', budget: 0, sort: 3 },
        ];

        // --- INIT & AUTH ---
        const storedConfig = localStorage.getItem('app_firebase_config');
        if(firebaseConfig.apiKey.includes('PASTE')) {
            if(storedConfig) initFirebase(JSON.parse(storedConfig));
            else document.getElementById('config-form').classList.remove('hidden');
        } else initFirebase(firebaseConfig);

        window.saveConfig = () => {
            try {
                let val = document.getElementById('firebase-config-input').value.trim();
                if(!val.startsWith('{')) val = `{${val}}`;
                const c = JSON.parse(val);
                localStorage.setItem('app_firebase_config', JSON.stringify(c));
                initFirebase(c);
                document.getElementById('config-form').classList.add('hidden');
            } catch(e) { alert("Invalid JSON."); }
        };

        function initFirebase(cfg) {
            try {
                app = firebase.initializeApp(cfg);
                auth = firebase.auth();
                db = firebase.firestore();
                auth.onAuthStateChanged(u => {
                    document.getElementById('loading-state').classList.add('hidden');
                    if(u) {
                        user = u;
                        document.getElementById('auth-container').classList.add('hidden');
                        document.getElementById('dashboard-container').classList.remove('hidden');
                        document.getElementById('user-email-display').textContent = u.email;
                        loadUserData();
                    } else {
                        document.getElementById('auth-container').classList.remove('hidden');
                        document.getElementById('login-form').classList.remove('hidden');
                    }
                });
            } catch(e) { console.error(e); document.getElementById('config-form').classList.remove('hidden'); }
        }

        window.handleLogin = async () => { try { await auth.signInWithEmailAndPassword(document.getElementById('email').value, document.getElementById('password').value); } catch(e) { document.getElementById('auth-error').textContent = e.message; document.getElementById('auth-error').classList.remove('hidden'); } };
        window.handleRegister = async () => { try { const cred = await auth.createUserWithEmailAndPassword(document.getElementById('email').value, document.getElementById('password').value); await uploadDefaultCategories(cred.user.uid); } catch(e) { document.getElementById('auth-error').textContent = e.message; document.getElementById('auth-error').classList.remove('hidden'); } };
        window.handleLogout = () => auth.signOut();

        async function loadUserData() {
            const [cSnap, tSnap, rSnap] = await Promise.all([
                db.collection(`users/${user.uid}/categories`).get(),
                db.collection(`users/${user.uid}/transactions`).get(),
                db.collection(`users/${user.uid}/rules`).get()
            ]);
            categories = cSnap.empty ? DEFAULT_CATEGORIES : cSnap.docs.map(d => d.data());
            transactions = tSnap.docs.map(d => ({id: d.id, ...d.data()}));
            rules = rSnap.docs.map(d => d.data());
            updateDashboard();
        }
        async function uploadDefaultCategories(uid) {
            const batch = db.batch();
            DEFAULT_CATEGORIES.forEach(cat => batch.set(db.collection(`users/${uid}/categories`).doc(cat.id), cat));
            await batch.commit();
        }

        // --- BULLETPROOF CSV PARSING ---
        // Splits line ensuring quotes are respected
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuote = false;
            for(let i=0; i<line.length; i++) {
                const c = line[i];
                if(c === '"') { if(inQuote && line[i+1] === '"'){ current += '"'; i++; } else { inQuote = !inQuote; } }
                else if(c === ',' && !inQuote) { result.push(current.trim()); current = ''; }
                else { current += c; }
            }
            result.push(current.trim());
            return result;
        }

        const smartParseCSV = (text) => {
            const lines = text.split('\n').filter(l => l.trim());
            if(lines.length < 2) return null;
            const headers = parseCSVLine(lines[0]).map(h => h.toLowerCase().trim().replace(/["']/g, ''));
            
            // 1. Detect Specific Bank Format (Credit Debit Indicator)
            let idx = {};
            const hasIndicator = headers.some(h => h.includes('credit debit indicator'));
            
            if(hasIndicator) {
                idx = {
                    date: headers.findIndex(h => h === 'transaction date'),
                    desc: headers.findIndex(h => h === 'description'),
                    amt: headers.findIndex(h => h === 'amount'),
                    type: headers.findIndex(h => h === 'credit debit indicator')
                };
            } else {
                // Fallback to general search
                idx = {
                    date: headers.findIndex(h => h.includes('date') && !h.includes('post')),
                    desc: headers.findIndex(h => h.includes('description') || h.includes('memo') || h.includes('payee')),
                    amt: headers.findIndex(h => h.includes('amount') || h==='amt'),
                    type: headers.findIndex(h => h.includes('type')),
                    debit: headers.findIndex(h => h.includes('debit')),
                    credit: headers.findIndex(h => h.includes('credit'))
                };
                if(idx.date === -1) idx.date = headers.findIndex(h => h.includes('date'));
            }

            if(idx.date === -1 || idx.amt === -1) return { error: "Missing Date or Amount column." };

            const data = [];
            for(let i=1; i<lines.length; i++) {
                const cols = parseCSVLine(lines[i]);
                if(cols.length < 2) continue; // Skip empty rows

                let dateStr = cols[idx.date];
                let desc = cols[idx.desc] || "No Description";
                let amount = 0;
                let type = 'expense';

                if (hasIndicator) {
                    // Specific logic for bank file with Indicator
                    let rawAmt = (cols[idx.amt] || "0").replace(/[$,]/g, '');
                    amount = parseFloat(rawAmt);
                    const ind = (cols[idx.type] || "").toLowerCase();
                    if(ind === 'credit') { type = 'income'; }
                    else { type = 'expense'; } // 'Debit' or anything else is expense
                } else {
                    // General Logic
                    if(idx.debit > -1 && idx.credit > -1) {
                         const d = parseFloat((cols[idx.debit]||"0").replace(/[$,]/g,''));
                         const c = parseFloat((cols[idx.credit]||"0").replace(/[$,]/g,''));
                         if(c > 0) { amount=c; type='income'; } else { amount=d; type='expense'; }
                    } else {
                        let rawAmt = (cols[idx.amt]||"0").replace(/[$,]/g,'');
                        amount = parseFloat(rawAmt);
                        if(idx.type > -1) {
                            const t = (cols[idx.type]||"").toLowerCase();
                            type = (t.includes('inc') || t.includes('cred')) ? 'income' : 'expense';
                            amount = Math.abs(amount);
                        } else {
                            if(amount < 0) { type='expense'; amount=Math.abs(amount); }
                            else type = 'expense';
                        }
                    }
                }

                const dateObj = parseDateFlexible(dateStr);
                if(dateObj && !isNaN(amount)) {
                    data.push({ date: dateObj, amount, type, description: desc });
                }
            }
            return { data };
        };

        // --- HELPERS ---
        function parseDateFlexible(raw) {
            if(!raw) return null;
            // Check YYYY-MM-DD first
            if(raw.match(/^\d{4}-\d{2}-\d{2}$/)) return raw;
            // Check MM/DD/YYYY (Bank format)
            const m = raw.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
            if(m) {
                const y = m[3];
                const mo = m[1].padStart(2, '0');
                const d = m[2].padStart(2, '0');
                return `${y}-${mo}-${d}`;
            }
            return null;
        }

        function getTxMonth(t) { return t.date ? t.date.substring(0, 7) : null; }
        function formatDateDisplay(d) { if(!d)return''; const p=d.split('-'); return `${p[1]}/${p[2]}/${p[0]}`; }
        function getUniqueMonthsCount(txs) { return new Set(txs.map(getTxMonth).filter(m => m !== null)).size || 1; }
        function formatMoney(n) { return new Intl.NumberFormat('en-US', {style:'currency', currency:'USD'}).format(n); }
        function getCatGroup(catName) { return categories.find(x => x.name === catName)?.group || 'Other Expenses'; }
        
        const showFeedback = (msg, err=false) => {
            const c = document.getElementById('feedback-container');
            c.innerHTML = `<div class="p-4 rounded-lg shadow-xl font-medium max-w-sm ${err?'bg-red-100 text-red-700':'bg-green-100 text-green-700'}">${msg}</div>`;
            c.classList.remove('opacity-0', 'pointer-events-none');
            setTimeout(() => c.classList.add('opacity-0', 'pointer-events-none'), 5000);
        };

        // --- UPDATE UI ---
        window.updateDashboard = () => {
            const monthFilter = document.getElementById('month-selector').value;
            const term = document.getElementById('search-input').value.toLowerCase();
            
            // Default Month Selection on Load
            const allMonths = [...new Set(transactions.map(getTxMonth).filter(Boolean))].sort().reverse();
            if(currentMonthFilter === 'all' && document.getElementById('month-selector').options.length <= 1 && allMonths.length > 0) {
                const now = new Date().toISOString().substring(0, 7);
                currentMonthFilter = allMonths.includes(now) ? now : allMonths[0];
            } else {
                currentMonthFilter = monthFilter;
            }

            const filtered = transactions.filter(t => {
                const m = getTxMonth(t);
                const matchMonth = currentMonthFilter === 'all' || m === currentMonthFilter;
                const matchSearch = !term || t.description.toLowerCase().includes(term) || t.category.toLowerCase().includes(term);
                return matchMonth && matchSearch;
            });

            // Refresh Selector
            const selector = document.getElementById('month-selector');
            if(selector.options.length !== allMonths.length + 1) {
                selector.innerHTML = `<option value="all">All Time</option>` + allMonths.map(m => {
                    const d = new Date(m+'-01T00:00:00');
                    const l = d.toLocaleString('default', {month:'short', year:'numeric'});
                    return `<option value="${m}">${l}</option>`;
                }).join('');
                selector.value = currentMonthFilter;
            }

            // Show/Hide Clear Button
            const clearBtn = document.getElementById('clear-all-btn');
            if(transactions.length > 0) clearBtn.classList.remove('hidden'); else clearBtn.classList.add('hidden');

            const multiplier = currentMonthFilter === 'all' ? (getUniqueMonthsCount(filtered)||1) : 1;

            updateSummary(filtered);
            updateCharts(filtered, multiplier);
            updateBudgetTable(filtered, multiplier);
            updateHistoryTable(filtered);
            renderGroupBreakdown(filtered);
            renderCatManager();
            lucide.createIcons();
        };

        function updateSummary(txs) {
            const inc = txs.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
            const exp = txs.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
            document.getElementById('summary-income').textContent = formatMoney(inc);
            document.getElementById('summary-expense').textContent = formatMoney(exp);
            const net = inc-exp;
            document.getElementById('summary-net').textContent = formatMoney(net);
            document.getElementById('summary-net').className = `text-2xl font-bold ${net >= 0 ? 'text-emerald-600':'text-rose-600'}`;
        }

        function updateCharts(txs, multiplier) {
            const groups = ['Necessary Spending', 'Giving', 'Additional Spending', 'Other Expenses'];
            const actuals = groups.map(g => txs.filter(t => getCatGroup(t.category) === g && t.type === 'expense').reduce((s,t)=>s+t.amount,0));
            const budgets = groups.map(g => categories.filter(c => c.group === g).reduce((s,c)=>s+(c.budget||0),0) * multiplier);
            if(charts.bar) charts.bar.destroy();
            charts.bar = new Chart(document.getElementById('budgetChart'), { type: 'bar', data: { labels: groups, datasets: [{ label: 'Spent', data: actuals, backgroundColor: '#ef4444' }, { label: 'Budget', data: budgets, backgroundColor: '#3b82f6' }] }, options: { responsive: true, maintainAspectRatio: false } });
            if(charts.doughnut) charts.doughnut.destroy();
            const expTxs = txs.filter(t => t.type === 'expense');
            const catSum = {}; expTxs.forEach(t => catSum[t.category] = (catSum[t.category]||0) + t.amount);
            const sorted = Object.entries(catSum).sort((a,b)=>b[1]-a[1]).slice(0,6);
            charts.doughnut = new Chart(document.getElementById('spendingChart'), { type: 'doughnut', data: { labels: sorted.map(x=>x[0]), datasets: [{ data: sorted.map(x=>x[1]), backgroundColor: ['#3b82f6','#ef4444','#10b981','#f59e0b','#8b5cf6','#ec4899'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {position: 'right'} } } });
        }

        function updateBudgetTable(txs, multiplier) {
            const tbody = document.getElementById('budget-table-body');
            document.getElementById('budget-multiplier-label').textContent = multiplier > 1 ? `${multiplier} Months` : 'Monthly';
            const spendMap = {}; txs.forEach(t => spendMap[t.category] = (spendMap[t.category]||0) + t.amount);
            const groups = ['Necessary Spending', 'Giving', 'Additional Spending', 'Other Expenses'];
            let html = '';
            groups.forEach(g => {
                const groupCats = categories.filter(c => (c.group || 'Other Expenses') === g && c.type === 'expense').sort((a,b) => (a.sort||99)-(b.sort||99));
                if(groupCats.length) {
                    html += `<tr class="bg-slate-100 text-xs font-bold uppercase"><td colspan="4" class="px-4 py-2">${g}</td></tr>`;
                    groupCats.forEach(c => {
                        const s = spendMap[c.name] || 0;
                        const b = (c.budget || 0) * multiplier;
                        const l = b - s;
                        const color = l < 0 ? 'text-red-600 font-bold' : 'text-green-600';
                        html += `<tr class="border-b"><td class="px-4 py-2">${c.name}</td><td class="px-4 py-2 text-right text-gray-400">${formatMoney(b)}</td><td class="px-4 py-2 text-right">${formatMoney(s)}</td><td class="px-4 py-2 text-right ${color}">${formatMoney(l)}</td></tr>`;
                    });
                }
            });
            tbody.innerHTML = html;
        }

        function updateHistoryTable(txs) {
            const tbody = document.getElementById('history-table-body');
            tbody.innerHTML = txs.sort((a,b)=>new Date(b.date)-new Date(a.date)).map(t => {
                const isEditing = editingId === t.id;
                const rowClass = t.category.includes('Uncategorized') ? 'uncategorized-row' : '';
                if(isEditing) {
                    const opts = categories.filter(c=>c.type===t.type).map(c=>`<option value="${c.name}" ${c.name===t.category?'selected':''}>${c.name}</option>`).join('');
                    return `<tr class="border-b bg-blue-50"><td colspan="5" class="p-2"><div class="flex flex-col gap-2"><div class="flex gap-2"><select id="edit-cat-${t.id}" class="p-1 border rounded text-xs flex-grow">${opts}</select><input type="text" id="edit-note-${t.id}" value="${t.note||''}" placeholder="Note" class="flex-1 p-1 border rounded text-xs"/></div><div class="flex justify-end gap-2"><button onclick="saveEdit('${t.id}')" class="bg-indigo-600 text-white px-3 py-1 rounded text-xs">Save</button><button onclick="cancelEdit()" class="text-gray-500 px-2 text-xs">Cancel</button></div></div></td></tr>`;
                }
                const displayDate = formatDateDisplay(t.date);
                return `<tr class="border-b hover:bg-gray-50 cursor-pointer ${rowClass}" onclick="toggleEdit('${t.id}')"><td class="px-4 py-2 text-xs text-gray-500">${displayDate}</td><td class="px-4 py-2 font-medium">${t.description}${t.note?` <i data-lucide="sticky-note" class="w-3 h-3 inline text-amber-400"></i>`:''}</td><td class="px-4 py-2 text-xs rounded inline-block mt-1 ${rowClass ? 'uncategorized-tag' : 'bg-gray-100'}">${t.category}</td><td class="px-4 py-2 text-right font-bold ${t.type==='income'?'text-emerald-600':'text-rose-500'}">${formatMoney(t.amount)}</td><td class="px-4 py-2 text-right"><button onclick="event.stopPropagation(); deleteTx('${t.id}')" class="text-red-400 hover:text-red-600">&times;</button></td></tr>`;
            }).join('');
        }

        function renderGroupBreakdown(txs) {
             const container = document.getElementById('group-breakdown-list');
             const groups = ['Income', 'Necessary Spending', 'Giving', 'Additional Spending', 'Other Expenses'];
             let html = '';
             groups.forEach(g => {
                 const total = txs.filter(t => {
                     const cat = categories.find(c => c.name === t.category);
                     const group = cat ? cat.group : (t.type==='income'?'Income':'Other Expenses');
                     return group === g;
                 }).reduce((sum, t) => sum + t.amount, 0);
                 if(total > 0) {
                     const color = g === 'Income' ? 'text-green-600' : 'text-red-600';
                     const border = g === 'Income' ? 'border-green-500' : 'border-red-500';
                     html += `<div class="flex justify-between items-center p-3 rounded border-l-4 ${border} bg-gray-50"><span class="font-bold text-sm">${g}</span><span class="${color} font-bold">${formatMoney(total)}</span></div>`;
                 }
             });
             container.innerHTML = html || '<p class="text-center text-gray-400 text-xs">No Data</p>';
        }
        
        const renderCatManager = () => {
             const container = document.getElementById('category-manager-container');
             let html = `<h3 class="font-bold border-b mb-2 text-sm text-gray-700 flex items-center gap-2"><i data-lucide="tags" class="w-4 h-4"></i> Categories & Rules</h3><div class="max-h-60 overflow-y-auto custom-scroll text-xs space-y-1 mb-4">`;
             categories.sort((a,b)=>a.name.localeCompare(b.name)).forEach(c => {
                 html += `<div class="flex justify-between p-2 hover:bg-gray-50 items-center border-b border-gray-100"><span>${c.name} ${c.budget>0?`<span class="text-slate-400">($${c.budget})</span>`:''}</span>${!c.name.includes('Uncategorized') ? `<button onclick="delCat('${c.id}')" class="text-red-400">&times;</button>`:''}</div>`;
             });
             html += `</div><h3 class="font-bold border-b mb-2 text-sm text-gray-700 mt-4">Active Rules</h3><div class="max-h-40 overflow-y-auto custom-scroll text-xs space-y-1">`;
             if(rules.length === 0) html += `<p class="text-gray-400 italic p-2">No rules yet.</p>`;
             else rules.forEach(r => { html += `<div class="flex justify-between p-2 bg-purple-50 rounded items-center"><span>"${r.keyword}" &rarr; ${r.categoryName}</span><button onclick="delRule('${r.id}')" class="text-red-500 font-bold">&times;</button></div>`; });
             html += `</div><button onclick="window.clearAllRules()" class="w-full mt-3 bg-white text-rose-600 border border-rose-200 text-xs py-2 rounded font-bold hover:bg-rose-50 transition">Clear All Rules</button>`;
             container.innerHTML = html;
        }

        // --- ACTIONS ---
        window.toggleEdit = (id) => { editingId = (editingId === id ? null : id); updateDashboard(); };
        window.cancelEdit = () => { editingId = null; updateDashboard(); };
        window.saveEdit = async (id) => {
            const newCat = document.getElementById(`edit-cat-${id}`).value;
            const note = document.getElementById(`edit-note-${id}`).value;
            await db.collection(`users/${user.uid}/transactions`).doc(id).update({ category: newCat, note: note });
            editingId = null;
            await fetchTransactions();
            updateDashboard();
        };
        window.deleteTx = async (id) => { if(confirm("Delete?")) { await db.collection(`users/${user.uid}/transactions`).doc(id).delete(); await fetchTransactions(); updateDashboard(); } };

        window.clearAllTransactions = async () => {
             if (!confirm("DELETE ALL transactions? This cannot be undone.")) return;
             transactions = []; updateDashboard();
             const b = db.batch();
             const s = await db.collection(`users/${user.uid}/transactions`).limit(400).get();
             s.forEach(d => b.delete(d.ref));
             await b.commit();
             showFeedback("Transactions cleared.", false);
             await fetchTransactions();
        };
        window.clearAllRules = async () => {
            if(!confirm("Delete ALL rules?")) return;
            rules = []; updateDashboard();
            const snaps = await db.collection(`users/${user.uid}/rules`).limit(400).get();
            const b = db.batch();
            snaps.forEach(doc => b.delete(doc.ref));
            await b.commit();
            await fetchRules();
            updateDashboard();
        };
        window.delCat = async (id) => { if(confirm("Delete category?")) { await db.collection(`users/${user.uid}/categories`).doc(id).delete(); await fetchCategories(); updateDashboard(); } };
        window.delRule = async (id) => { if(confirm("Delete rule?")) { await db.collection(`users/${user.uid}/rules`).doc(id).delete(); await fetchRules(); updateDashboard(); } };

        document.getElementById('csv-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if(!file) return;
            const text = await file.text();
            const parsed = smartParseCSV(text);
            if(!parsed || parsed.error) { alert(parsed?.error || "CSV Error"); return; }

            const batch = db.batch();
            let count = 0;
            const uncInc = categories.find(c=>c.name==='Uncategorized Income') || DEFAULT_CATEGORIES[0];
            const uncExp = categories.find(c=>c.name==='Uncategorized Expense') || DEFAULT_CATEGORIES[1];

            parsed.data.forEach(row => {
                let cat = row.type === 'income' ? uncInc.name : uncExp.name;
                const rule = rules.find(r => row.description.toUpperCase().includes(r.keyword.toUpperCase()));
                if(rule) cat = rule.categoryName;
                const ref = db.collection(`users/${user.uid}/transactions`).doc();
                batch.set(ref, { ...row, category: cat });
                count++;
            });
            await batch.commit();
            showFeedback(`Uploaded ${count} transactions.`);
            e.target.value = '';
            await fetchTransactions();
            updateDashboard();
        });
        
        document.getElementById('rules-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const text = await file.text();
            const lines = text.split('\n').slice(1);
            const batch = db.batch();
            lines.forEach(line => {
                const cols = parseCSVLine(line);
                if(cols.length>=2 && cols[0] && cols[1]) {
                    const ref = db.collection(`users/${user.uid}/rules`).doc();
                    batch.set(ref, { keyword: cols[0], categoryName: cols[1] });
                }
            });
            await batch.commit();
            showFeedback("Rules imported.");
            e.target.value = '';
            await fetchRules();
        });

        window.downloadBackup = () => { const blob = new Blob([JSON.stringify({categories, transactions, rules})], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `budget_backup.json`; a.click(); };
        window.restoreBackup = async (e) => { const file = e.target.files[0]; if (!file || !confirm("Restore?")) return; const data = JSON.parse(await file.text()); /* Restore logic */ alert("Restored."); };
        window.exportPortableReport = window.downloadBackup;
    </script>
</body>
</html>


