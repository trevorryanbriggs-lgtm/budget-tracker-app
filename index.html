<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cloud Budget Tracker</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Cloud Budget">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- FIREBASE LIBRARIES -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f3f4f6; }
        input, select, button { font-size: 16px !important; }
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .uncategorized-row { background-color: #fffbeb !important; }
        .uncategorized-tag { background-color: #fcd34d !important; color: #78350f !important; font-weight: 700; }
    </style>
</head>
<body class="min-h-screen text-gray-800 pb-20">

    <!-- AUTH SCREEN -->
    <div id="auth-container" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md space-y-6">
            <h1 class="text-3xl font-extrabold text-center text-indigo-600">Cloud Budget</h1>
            <div id="config-form" class="hidden space-y-4">
                <div class="bg-yellow-50 p-4 text-xs text-yellow-800 rounded"><strong>Action Required:</strong> Paste Firebase Config below.</div>
                <textarea id="firebase-config-input" rows="6" class="w-full p-3 border rounded text-xs font-mono bg-gray-50"></textarea>
                <button onclick="saveConfig()" class="w-full py-3 bg-gray-800 text-white rounded font-bold">Save Configuration</button>
            </div>
            <div id="login-form" class="hidden space-y-4">
                <input type="email" id="email" placeholder="Email" class="w-full p-3 border rounded-lg" />
                <input type="password" id="password" placeholder="Password" class="w-full p-3 border rounded-lg" />
                <div class="flex gap-2">
                    <button onclick="handleLogin()" class="flex-1 py-3 bg-indigo-600 text-white rounded-lg font-bold">Log In</button>
                    <button onclick="handleRegister()" class="flex-1 py-3 border border-indigo-600 text-indigo-600 rounded-lg font-bold">Sign Up</button>
                </div>
                <p id="auth-error" class="text-red-500 text-center text-sm hidden"></p>
            </div>
            <div id="loading-state" class="hidden text-center text-gray-500">Connecting...</div>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard-container" class="hidden">
        <header class="bg-indigo-700 text-white p-4 shadow-lg sticky top-0 z-50">
            <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
                <div>
                    <h1 class="text-xl font-bold">My Budget</h1>
                    <p id="user-email-display" class="text-xs text-indigo-200">Syncing...</p>
                </div>
                <div class="flex items-center gap-2 bg-indigo-800 p-1.5 rounded-lg">
                    <label class="text-xs font-bold uppercase tracking-wide text-indigo-200">Period:</label>
                    <select id="month-selector" onchange="window.updateDashboard()" class="bg-white text-indigo-900 text-sm font-bold rounded px-2 py-1 outline-none cursor-pointer">
                        <option value="all">All Time</option>
                    </select>
                </div>
                <div class="flex gap-2">
                    <button onclick="exportPortableReport()" class="text-xs bg-indigo-600 border border-indigo-400 px-3 py-1 rounded">Report</button>
                    <button onclick="handleLogout()" class="text-xs bg-indigo-800 border border-indigo-600 px-3 py-1 rounded">Logout</button>
                </div>
            </div>
        </header>

        <div class="max-w-7xl mx-auto p-4 space-y-6">
            <!-- Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-white p-4 rounded-xl card-shadow border-l-4 border-indigo-500">
                    <p class="text-xs font-bold text-gray-500 uppercase">Net Balance</p>
                    <p id="summary-net" class="text-2xl font-bold text-gray-800">$0.00</p>
                </div>
                <div class="bg-white p-4 rounded-xl card-shadow border-l-4 border-green-500">
                    <p class="text-xs font-bold text-gray-500 uppercase">Income</p>
                    <p id="summary-income" class="text-2xl font-bold text-green-600">$0.00</p>
                </div>
                <div class="bg-white p-4 rounded-xl card-shadow border-l-4 border-red-500">
                    <p class="text-xs font-bold text-gray-500 uppercase">Expenses</p>
                    <p id="summary-expense" class="text-2xl font-bold text-red-600">$0.00</p>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white p-4 rounded-xl card-shadow h-64"><canvas id="budgetChart"></canvas></div>
                <div class="bg-white p-4 rounded-xl card-shadow h-64"><canvas id="spendingChart"></canvas></div>
            </div>

            <!-- Main Content -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Right Column: Data -->
                <div class="lg:col-span-2 space-y-6 order-1 lg:order-2">
                    <!-- Budget Performance -->
                    <div class="bg-white rounded-xl card-shadow overflow-hidden">
                        <div class="bg-gray-50 px-4 py-3 border-b font-bold text-sm text-gray-700 flex justify-between">
                            <span>Budget Performance</span>
                            <span id="budget-multiplier-label" class="text-xs bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded">...</span>
                        </div>
                        <div class="overflow-x-auto max-h-96 no-scrollbar">
                            <table class="w-full text-sm text-left text-gray-500">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                    <tr><th class="px-4 py-3">Category</th><th class="px-4 py-3 text-right">Limit</th><th class="px-4 py-3 text-right">Spent</th><th class="px-4 py-3 text-right">Left</th></tr>
                                </thead>
                                <tbody id="budget-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                    <!-- Area Totals -->
                     <div class="bg-white rounded-xl card-shadow overflow-hidden p-4">
                        <h3 class="font-bold text-sm text-gray-700 mb-2">Area Totals</h3>
                        <div id="group-breakdown-list" class="space-y-2"></div>
                    </div>

                    <!-- Transactions -->
                    <div class="bg-white rounded-xl card-shadow overflow-hidden">
                        <div class="bg-gray-50 px-4 py-3 border-b flex justify-between items-center gap-2">
                            <div class="flex items-center gap-2">
                                <span class="font-bold text-sm text-gray-700">Transactions</span>
                                <button id="clear-all-btn" onclick="window.clearAllTransactions()" class="hidden text-[10px] font-bold text-white bg-red-500 hover:bg-red-600 px-2 py-1 rounded transition shadow-sm whitespace-nowrap">Clear All</button>
                            </div>
                            <input type="text" id="search-input" placeholder="Search..." class="text-xs p-1 border rounded w-32" oninput="window.updateDashboard()">
                        </div>
                        <div class="overflow-x-auto max-h-96">
                            <table class="w-full text-sm text-left text-gray-500">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                    <tr><th class="px-4 py-3">Date</th><th class="px-4 py-3">Desc</th><th class="px-4 py-3">Cat</th><th class="px-4 py-3 text-right">Amt</th><th class="px-4 py-3"></th></tr>
                                </thead>
                                <tbody id="history-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Left Column: Uploads -->
                <div class="lg:col-span-1 space-y-4 order-2 lg:order-1">
                    <div class="bg-white p-4 rounded-xl card-shadow space-y-4">
                        <h3 class="font-bold text-gray-700 text-sm border-b pb-2">Uploads</h3>
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-gray-500">Transactions CSV</label>
                            <input type="file" id="csv-input" accept=".csv" class="block w-full text-xs"/>
                            <p class="text-[10px] text-gray-400">Auto-detects format.</p>
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-gray-500">Rules CSV</label>
                            <input type="file" id="rules-input" accept=".csv" class="block w-full text-xs"/>
                            <p class="text-[10px] text-gray-400">Req: keyword, category</p>
                        </div>
                    </div>
                    
                    <div class="bg-white p-4 rounded-xl card-shadow border-l-4 border-blue-500">
                         <h3 class="font-bold text-gray-700 text-sm mb-2">Data Management</h3>
                         <div class="grid grid-cols-2 gap-2">
                             <button onclick="window.downloadBackup()" class="px-3 py-2 bg-blue-50 text-blue-700 rounded text-xs font-bold hover:bg-blue-100">Backup</button>
                             <label class="cursor-pointer px-3 py-2 bg-green-50 text-green-700 rounded text-xs font-bold hover:bg-green-100 text-center">
                                 Restore
                                 <input type="file" class="hidden" accept=".json" onchange="window.restoreBackup(event)">
                             </label>
                             <button onclick="window.clearAllTransactions()" class="col-span-2 bg-red-50 text-red-700 text-xs font-bold py-2 rounded hover:bg-red-100 border border-red-200 mt-2">Clear Transactions</button>
                              <button onclick="window.clearAllRules()" class="col-span-2 bg-purple-50 text-purple-700 text-xs font-bold py-2 rounded hover:bg-purple-100 border border-purple-200 mt-1">Clear Rules</button>
                         </div>
                    </div>

                    <div id="category-manager-container" class="bg-white p-4 rounded-xl card-shadow"></div>
                </div>
            </div>
        </div>
        <div id="feedback-container" class="fixed top-4 right-4 z-50 transition-opacity duration-300 opacity-0 pointer-events-none"></div>
    </div>

    <script>
        // --- INIT ICONS ---
        lucide.createIcons();

        // --- FIREBASE CONFIG (PASTE HERE) ---
        const firebaseConfig = {
  apiKey: "AIzaSyCvMCXuKODkxL2Ni9axSNb4LN7GgtDfazM",
  authDomain: "tb-budget-app.firebaseapp.com",
  projectId: "tb-budget-app",
  storageBucket: "tb-budget-app.firebasestorage.app",
  messagingSenderId: "339537167812",
  appId: "1:339537167812:web:a5012ceb3ae64ae120d091",
  measurementId: "G-LDL269R8YQ"
};

        let app, auth, db, user;
        let categories=[], transactions=[], rules=[], charts={}, editingId=null;
        let currentMonthFilter = 'all';

        // --- DEFAULTS ---
        const DEFAULT_CATEGORIES = [
            { id: 'unc-inc', name: 'Uncategorized Income', type: 'income', group: 'Income', budget: 0, sort: 1 },
            { id: 'unc-exp', name: 'Uncategorized Expense', type: 'expense', group: 'Other Expenses', budget: 0, sort: 99 },
            { id: 'nec-1', name: 'Groceries & Household', type: 'expense', group: 'Necessary Spending', budget: 850.00, sort: 10 },
            { id: 'nec-2', name: 'House (auto-pay)', type: 'expense', group: 'Necessary Spending', budget: 2150.64, sort: 11 },
            { id: 'nec-3', name: 'EDJ Roth auto-draft (1st of month)', type: 'expense', group: 'Necessary Spending', budget: 460.00, sort: 12 },
            { id: 'nec-4', name: 'Electric (Ameren)', type: 'expense', group: 'Necessary Spending', budget: 200.00, sort: 13 },
            { id: 'nec-5', name: 'Waste Management', type: 'expense', group: 'Necessary Spending', budget: 35.00, sort: 14 },
            { id: 'nec-6', name: 'Water (PWSD)', type: 'expense', group: 'Necessary Spending', budget: 100.00, sort: 15 },
            { id: 'nec-7', name: 'Sewage (American Water)', type: 'expense', group: 'Necessary Spending', budget: 70.00, sort: 16 },
            { id: 'nec-8', name: 'Gas', type: 'expense', group: 'Necessary Spending', budget: 400.00, sort: 17 },
            { id: 'nec-9', name: 'Internet (Spectrum)', type: 'expense', group: 'Necessary Spending', budget: 50.00, sort: 18 },
            { id: 'nec-10', name: 'Gym Membership', type: 'expense', group: 'Necessary Spending', budget: 60.00, sort: 19 },
            { id: 'nec-11', name: 'T-Mobile Cell Phone (auto-pay)', type: 'expense', group: 'Necessary Spending', budget: 60.00, sort: 20 },
            { id: 'nec-12', name: 'Medical Insurance', type: 'expense', group: 'Necessary Spending', budget: 52.00, sort: 21 },
            { id: 'nec-13', name: 'Lincoln Life Ins. ($26 & $22)', type: 'expense', group: 'Necessary Spending', budget: 48.00, sort: 22 },
            { id: 'nec-14', name: 'Dental Insurance (Trevor)', type: 'expense', group: 'Necessary Spending', budget: 24.00, sort: 23 },
            { id: 'nec-15', name: 'USAA (Car Insurance $90 twice/mo)', type: 'expense', group: 'Necessary Spending', budget: 208.00, sort: 24 },
            { id: 'nec-16', name: 'Zander (ID Theft)', type: 'expense', group: 'Necessary Spending', budget: 13.00, sort: 25 },
            { id: 'nec-17', name: 'App (25th auto-pay)', type: 'expense', group: 'Necessary Spending', budget: 17.00, sort: 26 },
            { id: 'giv-1', name: 'Church', type: 'expense', group: 'Giving', budget: 325.00, sort: 30 },
            { id: 'giv-2', name: 'Multiply Campaign', type: 'expense', group: 'Giving', budget: 85.00, sort: 31 },
            { id: 'giv-3', name: 'Bloom INTL', type: 'expense', group: 'Giving', budget: 40.00, sort: 32 },
            { id: 'giv-4', name: 'Convoy of Hope', type: 'expense', group: 'Giving', budget: 51.50, sort: 33 },
            { id: 'giv-5', name: 'DirectConnect (PayPal 25th)', type: 'expense', group: 'Giving', budget: 20.00, sort: 34 },
            { id: 'giv-6', name: 'Cheryl Recurring Donation', type: 'expense', group: 'Giving', budget: 51.50, sort: 35 },
            { id: 'giv-7', name: 'Joy FM', type: 'expense', group: 'Giving', budget: 40.00, sort: 36 },
            { id: 'giv-8', name: 'Hostetter Ministries', type: 'expense', group: 'Giving', budget: 80.00, sort: 37 },
            { id: 'giv-9', name: 'Micellaneous Giving', type: 'expense', group: 'Giving', budget: 0.00, sort: 38 },
            { id: 'giv-10', name: 'Transfer to Giving Savings', type: 'expense', group: 'Giving', budget: 40.00, sort: 39 },
            { id: 'add-1', name: 'Eating Out/Dates', type: 'expense', group: 'Additional Spending', budget: 100.00, sort: 50 },
            { id: 'add-2', name: 'Kristi Fun Money', type: 'expense', group: 'Additional Spending', budget: 0.00, sort: 51 },
            { id: 'add-3', name: 'Trevor Fun Money', type: 'expense', group: 'Additional Spending', budget: 50.00, sort: 52 },
            { id: 'add-4', name: 'icloud', type: 'expense', group: 'Additional Spending', budget: 4.00, sort: 53 },
            { id: 'add-5', name: 'Streaming', type: 'expense', group: 'Additional Spending', budget: 10.00, sort: 54 },
            { id: 'add-6', name: 'Home Spending', type: 'expense', group: 'Additional Spending', budget: 0.00, sort: 55 },
            { id: 'add-7', name: 'Extra House Savings', type: 'expense', group: 'Additional Spending', budget: 150.00, sort: 56 },
            { id: 'add-8', name: 'Overflow Savings', type: 'expense', group: 'Additional Spending', budget: 400.00, sort: 57 },
            { id: 'add-9', name: 'Edward Jones Joint Transfer', type: 'expense', group: 'Additional Spending', budget: 0.00, sort: 58 },
            { id: 'add-10', name: 'Arkansas Trip', type: 'expense', group: 'Additional Spending', budget: 0.00, sort: 59 },
            { id: 'add-11', name: 'Doggy Daycare', type: 'expense', group: 'Additional Spending', budget: 144.00, sort: 60 },
            { id: 'add-12', name: 'Unbudgeted Expenses', type: 'expense', group: 'Additional Spending', budget: 0.00, sort: 61 },
            { id: 'inc-1', name: 'Salary (Kristi)', type: 'income', group: 'Income', budget: 0, sort: 2 },
            { id: 'inc-2', name: 'Salary (Trevor)', type: 'income', group: 'Income', budget: 0, sort: 3 },
        ];

        const storedConfig = localStorage.getItem('app_firebase_config');
        if(firebaseConfig.apiKey.includes('PASTE')) {
            if(storedConfig) initFirebase(JSON.parse(storedConfig));
            else document.getElementById('config-form').classList.remove('hidden');
        } else initFirebase(firebaseConfig);

        window.saveConfig = () => {
            try {
                let val = document.getElementById('firebase-config-input').value.trim();
                if(!val.startsWith('{')) val = `{${val}}`;
                const c = JSON.parse(val);
                localStorage.setItem('app_firebase_config', JSON.stringify(c));
                initFirebase(c);
                document.getElementById('config-form').classList.add('hidden');
            } catch(e) { alert("Invalid JSON."); }
        };

        function initFirebase(cfg) {
            try {
                app = firebase.initializeApp(cfg);
                auth = firebase.auth();
                db = firebase.firestore();
                auth.onAuthStateChanged(u => {
                    document.getElementById('loading-state').classList.add('hidden');
                    if(u) {
                        user = u;
                        document.getElementById('auth-container').classList.add('hidden');
                        document.getElementById('dashboard-container').classList.remove('hidden');
                        document.getElementById('user-email-display').textContent = u.email;
                        loadUserData();
                    } else {
                        document.getElementById('auth-container').classList.remove('hidden');
                        document.getElementById('login-form').classList.remove('hidden');
                    }
                });
            } catch(e) { console.error(e); document.getElementById('config-form').classList.remove('hidden'); }
        }

        window.handleLogin = async () => { try { await auth.signInWithEmailAndPassword(document.getElementById('email').value, document.getElementById('password').value); } catch(e) { document.getElementById('auth-error').textContent = e.message; document.getElementById('auth-error').classList.remove('hidden'); } };
        window.handleRegister = async () => { try { const cred = await auth.createUserWithEmailAndPassword(document.getElementById('email').value, document.getElementById('password').value); await uploadDefaultCategories(cred.user.uid); } catch(e) { document.getElementById('auth-error').textContent = e.message; document.getElementById('auth-error').classList.remove('hidden'); } };
        window.handleLogout = () => auth.signOut();

        async function loadUserData() {
            const [c, t, r] = await Promise.all([
                db.collection(`users/${user.uid}/categories`).get(),
                db.collection(`users/${user.uid}/transactions`).get(),
                db.collection(`users/${user.uid}/rules`).get()
            ]);
            categories = c.empty ? DEFAULT_CATEGORIES : c.docs.map(d => d.data());
            transactions = t.docs.map(d => ({id: d.id, ...d.data()}));
            rules = r.docs.map(d => d.data());
            updateDashboard();
        }

        async function uploadDefaultCategories(uid) {
            const batch = db.batch();
            DEFAULT_CATEGORIES.forEach(cat => {
                const ref = db.collection(`users/${uid}/categories`).doc(cat.id);
                batch.set(ref, cat);
            });
            await batch.commit();
        }

        // --- ROBUST CSV PARSING ---
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuote = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    if (inQuote && line[i + 1] === '"') { current += '"'; i++; } 
                    else { inQuote = !inQuote; }
                } else if (char === ',' && !inQuote) {
                    result.push(current.trim()); current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }

        function parseSmartCSV(text) {
            const lines = text.split('\n').filter(l => l.trim());
            if(lines.length < 2) return null;
            const headers = parseCSVLine(lines[0]).map(h => h.toLowerCase().trim());
            
            // Detect Columns
            let idx = {
                date: headers.findIndex(h => h.includes('date') && !h.includes('post')),
                desc: headers.findIndex(h => h.includes('desc') || h.includes('memo') || h.includes('payee') || h.includes('merchant')),
                amt: headers.findIndex(h => h === 'amount' || h.includes('amount')),
                type: headers.findIndex(h => h.includes('type') || h.includes('indicator') || h.includes('credit debit')),
                debit: headers.findIndex(h => h.includes('debit')),
                credit: headers.findIndex(h => h.includes('credit'))
            };
            if (idx.date === -1) idx.date = headers.findIndex(h => h.includes('date'));
            if (idx.date === -1 || (idx.amt === -1 && idx.debit === -1)) return { error: "Header mismatch. Need Date/Amount." };

            const data = [];
            for(let i=1; i<lines.length; i++) {
                const cols = parseCSVLine(lines[i]);
                if(cols.length < 2) continue;
                
                let dateStr = cols[idx.date];
                let desc = cols[idx.desc] || "No Description";
                let amount = 0;
                let type = 'expense';

                // Amount Logic
                if(idx.debit > -1 && idx.credit > -1) {
                    const dVal = parseFloat((cols[idx.debit]||"0").replace(/[$,]/g,''));
                    const cVal = parseFloat((cols[idx.credit]||"0").replace(/[$,]/g,''));
                    if(cVal > 0) { amount = cVal; type = 'income'; } else { amount = dVal; type = 'expense'; }
                } else if (idx.amt > -1) {
                    let rawAmt = (cols[idx.amt]||"0").replace(/[$,]/g,'');
                    amount = parseFloat(rawAmt);
                    if (idx.type > -1) {
                        const tVal = (cols[idx.type]||"").toLowerCase();
                        if(tVal.includes('credit') || tVal.includes('dep') || tVal.includes('inc')) type = 'income';
                        else type = 'expense';
                        amount = Math.abs(amount);
                    } else {
                         if(amount < 0) { type = 'expense'; amount = Math.abs(amount); }
                         else type = 'expense'; // Default
                    }
                }

                const dateObj = parseDateFlexible(dateStr);
                if(dateObj && !isNaN(amount)) {
                    data.push({ date: dateObj, amount, type, description: desc });
                }
            }
            return { data };
        }

        // --- HELPERS ---
        function parseDateFlexible(raw) {
            if(!raw) return null;
            // 1. YYYY-MM-DD
            if(raw.match(/^\d{4}-\d{2}-\d{2}$/)) return raw;
            // 2. MM/DD/YYYY or M/D/YY
            const m = raw.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
            if(m) {
                let y = m[3]; if(y.length===2) y='20'+y;
                return `${y}-${m[1].padStart(2,'0')}-${m[2].padStart(2,'0')}`;
            }
            // 3. Fallback
            const d = new Date(raw);
            return isNaN(d) ? null : d.toISOString().split('T')[0];
        }

        function getTxMonth(t) { return t.date ? t.date.substring(0, 7) : null; }
        function formatDateDisplay(d) { if(!d)return''; const p=d.split('-'); return `${p[1]}/${p[2]}/${p[0]}`; }
        function getUniqueMonthsCount(txs) { return new Set(txs.map(getTxMonth).filter(m => m !== null)).size || 1; }
        function formatMoney(n) { return new Intl.NumberFormat('en-US', {style:'currency', currency:'USD'}).format(n); }
        function getCatGroup(catName) { return categories.find(x => x.name === catName)?.group || 'Other Expenses'; }
        const showFeedback = (msg, err=false) => {
            const c = document.getElementById('feedback-container');
            c.innerHTML = `<div class="p-4 rounded-lg shadow-xl font-medium max-w-sm ${err?'bg-red-100 text-red-700':'bg-green-100 text-green-700'}">${msg}</div>`;
            c.classList.remove('opacity-0', 'pointer-events-none');
            setTimeout(() => c.classList.add('opacity-0', 'pointer-events-none'), 4000);
        };

        // --- UPDATE ---
        window.updateDashboard = () => {
            const selector = document.getElementById('month-selector');
            const currentMonth = new Date().toISOString().substring(0, 7);
            const allMonths = [...new Set(transactions.map(getTxMonth).filter(Boolean))].sort().reverse();
            
            // Auto-select current month logic on first load
            if(currentMonthFilter === 'all' && selector.options.length <= 1) {
                if (allMonths.includes(currentMonth)) currentMonthFilter = currentMonth;
                else if (allMonths.length > 0) currentMonthFilter = allMonths[0];
            } else {
                currentMonthFilter = selector.value;
            }

            const term = document.getElementById('search-input').value.toLowerCase();
            const filtered = transactions.filter(t => {
                const m = getTxMonth(t);
                const matchMonth = currentMonthFilter === 'all' || m === currentMonthFilter;
                const matchSearch = !term || t.description.toLowerCase().includes(term) || t.category.toLowerCase().includes(term) || (t.note && t.note.toLowerCase().includes(term));
                return matchMonth && matchSearch;
            });

            if(selector.options.length !== allMonths.length + 1) {
                selector.innerHTML = `<option value="all">All Time</option>` + allMonths.map(m => {
                    const d = new Date(m+'-01T00:00:00');
                    const label = d.toLocaleString('default', {month:'short', year:'numeric'});
                    return `<option value="${m}">${label}</option>`;
                }).join('');
            }
            selector.value = currentMonthFilter;
            
            const clearBtn = document.getElementById('clear-all-btn');
            if(transactions.length > 0) clearBtn.classList.remove('hidden'); else clearBtn.classList.add('hidden');

            const multiplier = currentMonthFilter === 'all' ? (getUniqueMonthsCount(filtered) || 1) : 1;

            updateSummary(filtered);
            updateCharts(filtered, multiplier);
            updateBudgetTable(filtered, multiplier);
            updateHistoryTable(filtered);
            renderGroupBreakdown(filtered);
            renderCatManager();
            lucide.createIcons();
        };

        // Hooks
        document.getElementById('month-selector').addEventListener('change', (e) => {
             currentMonthFilter = e.target.value;
             window.updateDashboard();
        });

        // Update functions (Summary, Charts, etc. similar logic to before but stable)
        function updateSummary(txs) {
            const inc = txs.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
            const exp = txs.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
            document.getElementById('summary-income').textContent = formatMoney(inc);
            document.getElementById('summary-expense').textContent = formatMoney(exp);
            const net = inc-exp;
            document.getElementById('summary-net').textContent = formatMoney(net);
            document.getElementById('summary-net').className = `text-2xl font-bold ${net >= 0 ? 'text-green-600':'text-red-600'}`;
        }

        function updateCharts(txs, multiplier) {
            const groups = ['Necessary Spending', 'Giving', 'Additional Spending', 'Other Expenses'];
            const actuals = groups.map(g => txs.filter(t => getCatGroup(t.category) === g && t.type === 'expense').reduce((s,t)=>s+t.amount,0));
            const budgets = groups.map(g => categories.filter(c => c.group === g).reduce((s,c)=>s+(c.budget||0),0) * multiplier);
            if(charts.bar) charts.bar.destroy();
            charts.bar = new Chart(document.getElementById('budgetChart'), {
                type: 'bar',
                data: { labels: groups, datasets: [{ label: 'Spent', data: actuals, backgroundColor: '#ef4444' }, { label: 'Budget', data: budgets, backgroundColor: '#3b82f6' }] },
                options: { responsive: true, maintainAspectRatio: false }
            });
            if(charts.doughnut) charts.doughnut.destroy();
            const expTxs = txs.filter(t => t.type === 'expense');
            const catSum = {}; expTxs.forEach(t => catSum[t.category] = (catSum[t.category]||0) + t.amount);
            const sorted = Object.entries(catSum).sort((a,b)=>b[1]-a[1]).slice(0,6);
            charts.doughnut = new Chart(document.getElementById('spendingChart'), {
                type: 'doughnut',
                data: { labels: sorted.map(x=>x[0]), datasets: [{ data: sorted.map(x=>x[1]), backgroundColor: ['#3b82f6','#ef4444','#10b981','#f59e0b','#8b5cf6','#ec4899'] }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {position: 'right'} } }
            });
        }

        function updateBudgetTable(txs, multiplier) {
            const tbody = document.getElementById('budget-table-body');
            document.getElementById('budget-multiplier-label').textContent = multiplier > 1 ? `${multiplier} Months` : 'Monthly';
            const spendMap = {}; txs.forEach(t => spendMap[t.category] = (spendMap[t.category]||0) + t.amount);
            const groups = ['Necessary Spending', 'Giving', 'Additional Spending', 'Other Expenses'];
            let html = '';
            groups.forEach(g => {
                const groupCats = categories.filter(c => (c.group || 'Other Expenses') === g && c.type === 'expense').sort((a,b) => (a.sort||99)-(b.sort||99));
                if(groupCats.length) {
                    html += `<tr class="bg-slate-100 text-xs font-bold uppercase"><td colspan="4" class="px-4 py-2">${g}</td></tr>`;
                    groupCats.forEach(c => {
                        const s = spendMap[c.name] || 0;
                        const b = (c.budget || 0) * multiplier;
                        const l = b - s;
                        const color = l < 0 ? 'text-red-600 font-bold' : 'text-green-600';
                        html += `<tr class="border-b"><td class="px-4 py-2">${c.name}</td><td class="px-4 py-2 text-right text-gray-400">${formatMoney(b)}</td><td class="px-4 py-2 text-right">${formatMoney(s)}</td><td class="px-4 py-2 text-right ${color}">${formatMoney(l)}</td></tr>`;
                    });
                }
            });
            tbody.innerHTML = html;
        }

        function updateHistoryTable(txs) {
            const tbody = document.getElementById('history-table-body');
            tbody.innerHTML = txs.sort((a,b)=>new Date(b.date)-new Date(a.date)).map(t => {
                const isEditing = editingId === t.id;
                const rowClass = t.category.includes('Uncategorized') ? 'uncategorized-row' : '';
                const displayDate = formatDateDisplay(t.date);
                if(isEditing) {
                    const opts = categories.filter(c=>c.type===t.type).map(c=>`<option value="${c.name}" ${c.name===t.category?'selected':''}>${c.name}</option>`).join('');
                    return `<tr class="border-b bg-blue-50"><td colspan="5" class="p-2"><div class="flex flex-col gap-2"><div class="flex gap-2"><select id="edit-cat-${t.id}" class="p-1 border rounded text-xs flex-grow">${opts}</select><input type="text" id="edit-note-${t.id}" value="${t.note||''}" placeholder="Note" class="flex-1 p-1 border rounded text-xs"/></div><div class="flex justify-end gap-2"><button onclick="saveEdit('${t.id}')" class="bg-indigo-600 text-white px-3 py-1 rounded text-xs">Save</button><button onclick="cancelEdit()" class="text-gray-500 px-2 text-xs">Cancel</button></div></div></td></tr>`;
                }
                return `<tr class="border-b hover:bg-gray-50 cursor-pointer ${rowClass}" onclick="toggleEdit('${t.id}')"><td class="px-4 py-2 text-xs text-gray-500">${displayDate}</td><td class="px-4 py-2 font-medium">${t.description}${t.note?` <i data-lucide="sticky-note" class="w-3 h-3 inline text-amber-400"></i>`:''}</td><td class="px-4 py-2 text-xs rounded inline-block mt-1 ${rowClass ? 'uncategorized-tag' : 'bg-gray-100'}">${t.category}</td><td class="px-4 py-2 text-right font-bold ${t.type==='income'?'text-emerald-600':'text-rose-500'}">${formatMoney(t.amount)}</td><td class="px-4 py-2 text-right"><button onclick="event.stopPropagation(); deleteTx('${t.id}')" class="text-red-400 hover:text-red-600">&times;</button></td></tr>`;
            }).join('');
            lucide.createIcons();
        }

        function renderGroupBreakdown(txs) {
            const container = document.getElementById('group-breakdown-list');
            const groups = ['Income', 'Necessary Spending', 'Giving', 'Additional Spending', 'Other Expenses'];
            let html = '';
            groups.forEach(g => {
                const total = txs.filter(t => {
                    const cat = categories.find(c => c.name === t.category);
                    const group = cat ? cat.group : (t.type==='income'?'Income':'Other Expenses');
                    return group === g;
                }).reduce((sum, t) => sum + t.amount, 0);
                if(total > 0) {
                    const color = g==='Income'?'text-emerald-600':'text-rose-600';
                    html += `<div class="flex justify-between p-2 border-b"><span class="text-sm font-bold">${g}</span><span class="text-sm font-bold ${color}">${formatMoney(total)}</span></div>`;
                }
            });
            container.innerHTML = html;
        }

        const renderCatManager = () => {
             const container = document.getElementById('category-manager-container');
             let html = `<h3 class="font-bold border-b mb-2 text-sm text-gray-700 flex items-center gap-2"><i data-lucide="tags" class="w-4 h-4"></i> Categories & Rules</h3><div class="max-h-60 overflow-y-auto custom-scroll text-xs space-y-1 mb-4">`;
             categories.sort((a,b)=>a.name.localeCompare(b.name)).forEach(c => {
                 html += `<div class="flex justify-between p-2 hover:bg-gray-50 items-center rounded border border-transparent hover:border-gray-100"><span>${c.name} ${c.budget>0?`<span class="text-slate-400 ml-1">($${c.budget})</span>`:''}</span>${!c.name.includes('Uncategorized') ? `<button onclick="delCat('${c.id}')" class="text-red-400">&times;</button>`:''}</div>`;
             });
             html += `</div><h3 class="font-bold border-b mb-2 text-sm text-gray-700 mt-4">Active Rules</h3><div class="max-h-40 overflow-y-auto custom-scroll text-xs space-y-1">`;
             if(rules.length === 0) html += `<p class="text-gray-400 italic p-2">No rules yet.</p>`;
             else rules.forEach(r => { html += `<div class="flex justify-between p-2 bg-purple-50 rounded items-center"><span>"${r.keyword}" &rarr; ${r.categoryName}</span><button onclick="delRule('${r.id}')" class="text-red-500 font-bold">&times;</button></div>`; });
             html += `</div><button onclick="window.clearAllRules()" class="w-full mt-3 bg-white text-rose-600 border border-rose-200 text-xs py-2 rounded font-bold hover:bg-rose-50 transition">Clear All Rules</button>`;
             container.innerHTML = html;
        }

        // Actions
        window.toggleEdit = (id) => { editingId = (editingId === id ? null : id); updateDashboard(); };
        window.cancelEdit = () => { editingId = null; updateDashboard(); };
        window.saveEdit = async (id) => {
            const newCat = document.getElementById(`edit-cat-${id}`).value;
            const note = document.getElementById(`edit-note-${id}`).value;
            await db.collection(`users/${user.uid}/transactions`).doc(id).update({ category: newCat, note: note });
            editingId = null;
            await fetchTransactions();
            updateDashboard();
        };
        window.deleteTx = async (id) => { if(confirm("Delete?")) { await db.collection(`users/${user.uid}/transactions`).doc(id).delete(); await fetchTransactions(); updateDashboard(); } };
        
        window.clearAllTransactions = async () => {
             if (!confirm("Delete ALL transactions?")) return;
             // UI Instant Clear
             transactions = []; updateDashboard();
             const b = db.batch();
             const snaps = await db.collection(`users/${user.uid}/transactions`).limit(400).get();
             snaps.forEach(doc => b.delete(doc.ref));
             await b.commit();
             showFeedback("Transactions cleared.");
             await fetchTransactions(); // Verify
        };

        window.clearAllRules = async () => {
            if(!confirm("Delete ALL rules?")) return;
            rules = []; updateDashboard();
            const snaps = await db.collection(`users/${user.uid}/rules`).limit(400).get();
            const b = db.batch();
            snaps.forEach(doc => b.delete(doc.ref));
            await b.commit();
            showFeedback("Rules cleared.");
            await fetchRules();
        };

        window.delCat = async (id) => { if(confirm("Delete category?")) { await db.collection(`users/${user.uid}/categories`).doc(id).delete(); await fetchCategories(); updateDashboard(); } };
        window.delRule = async (id) => { if(confirm("Delete rule?")) { await db.collection(`users/${user.uid}/rules`).doc(id).delete(); await fetchRules(); updateDashboard(); } };

        // Imports
        document.getElementById('csv-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if(!file) return;
            const text = await file.text();
            const parsed = smartParseCSV(text);
            if(!parsed || parsed.error) { alert(parsed?.error || "CSV Error"); return; }

            const batch = db.batch();
            let count = 0;
            const uncInc = categories.find(c=>c.name==='Uncategorized Income') || DEFAULT_CATEGORIES[0];
            const uncExp = categories.find(c=>c.name==='Uncategorized Expense') || DEFAULT_CATEGORIES[1];
            
            parsed.data.forEach(row => {
                let cat = row.type === 'income' ? uncInc.name : uncExp.name;
                const rule = rules.find(r => row.description.toUpperCase().includes(r.keyword.toUpperCase()));
                if(rule) cat = rule.categoryName;
                const ref = db.collection(`users/${user.uid}/transactions`).doc();
                batch.set(ref, { ...row, category: cat });
                count++;
            });
            await batch.commit();
            showFeedback(`Uploaded ${count} transactions.`);
            e.target.value = '';
            await fetchTransactions();
            updateDashboard();
        });

        document.getElementById('rules-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if(!file) return;
            const text = await file.text();
            const lines = text.split('\n').slice(1);
            const batch = db.batch();
            lines.forEach(line => {
                const cols = parseCSVLine(line);
                if(cols.length>=2 && cols[0] && cols[1]) {
                    const ref = db.collection(`users/${user.uid}/rules`).doc();
                    batch.set(ref, { keyword: cols[0], categoryName: cols[1] });
                }
            });
            await batch.commit();
            showFeedback("Rules imported.");
            e.target.value = '';
            await fetchRules();
        });

        // Export/Backup
        window.downloadBackup = () => {
            const blob = new Blob([JSON.stringify({categories, transactions, rules})], {type:'application/json'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `budget_backup.json`; a.click();
        };
        window.restoreBackup = async (e) => {
             const file = e.target.files[0];
             if (!file || !confirm("Restore will merge. Continue?")) return;
             const data = JSON.parse(await file.text());
             const batch = db.batch();
             data.categories.forEach(c => batch.set(db.collection(`users/${user.uid}/categories`).doc(c.id), c));
             data.transactions.forEach(t => batch.set(db.collection(`users/${user.uid}/transactions`).doc(t.id), t));
             data.rules.forEach(r => batch.set(db.collection(`users/${user.uid}/rules`).doc(r.id||crypto.randomUUID()), r));
             await batch.commit();
             showFeedback("Restored.");
             loadUserData();
             e.target.value = '';
        };
        window.exportPortableReport = window.downloadBackup;
    </script>
</body>
</html>



